<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Customer Interface</title>
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
	</head>
	<body>
		<div class="container">
			<h1>Toucher</h1>

			<form>
				<div class="form-group">
					<label for="customer_id">Me</label>
					<select class="form-control" id="customer_id">

					</select>
				</div>

				<div class="form-group">
					<label for="address">Address</label>
					<div class="form-inline">
						<button type="button" class="btn btn-default" id="locate">Locate</button>

					</div>
					<div id="geolocation_ids" />
				</div>
				<div class="form-group">
					<label for="notes">Notes</label>
					<input type="text" class="form-control" id="notes" placeholder="I really like this guy">
				</div>
				<button type="submit" class="btn btn-default disabled">Touch</button>
			</form>
		</div>
		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<!-- Include all compiled plugins (below), or include individual files as needed -->
		<script src="js/bootstrap.min.js"></script>
		<script language="JavaScript">
		$(document).ready(function(){

			// Load Employee names in the list
			$.getJSON("/employees", function(data){

				if(data.status=="success") {


					$.each(data.data, function(i,o){

						$("#customer_id").append("<option value=\""+o.id+"\">"+o.fullname+"</option>");
					});


				} else {

					alert("Database says: "+data.message);
				}
			});

			// Wire up locate button
			$("#locate").click(function(){

				// Empty previous
				$("#geolocation_ids").empty();

				// Get lat/lon
				if(navigator.geolocation) {

					$("label[for=address]").text("Address (accessing GPS...)");
					navigator.geolocation.getCurrentPosition(function(position){

						var lat=position.coords.latitude;
						var lon=position.coords.longitude;
						$("label[for=address]").text("Address (searching database...)");

						// Get Geolocation

						$.getJSON("/geolocations",{ "lat" : lat, "lon" : lon}, function(data){

							if(data.status=="success") {


								$("label[for=address]").text("Address (near "+lat+", "+lon+")");
								$.each(data.data, function(i,o){
									var cust_class = "";
									var touch_class = "";
									if(o.cur_customer) {
										cust_class=" disabled ";
									}
									if(o.has_touch) {
										touch_class=" text-danger ";
									}
									$("#geolocation_ids").append("<div class=\"radio "+touch_class+"\"><label><input type=\"radio\" name=\"geolocation_id\"  value=\""+o.id+"\""+cust_class+">"+o.address+"</label></div>");
								});

								// Check 1st one
								$("input[name=geolocation_id]:first").attr("checked","checked");

								// Enable the submit button
								$("button[type=submit]").text("Touch").removeClass("disabled");

							} else {

								alert("Database says: "+data.message);
							}
						});
					});

				} else {

					alert("Geolocation does not appear to be supported on this browser");
				}

			}).click();


			// Catch form submit
			$("form").submit(function(){

				if(!$("input[name=geolocation_id]:checked").length){

					alert("Please select a location first");
					return false;
				}

				$("button[type=submit]").text("...").addClass("disabled");
				$.post("/touches",
					{
						"geolocation_id":	$("input[name=geolocation_id]:checked").val(),
						"customer_id"	:	$("#customer_id").val(),
						"notes"			:	$("#notes").val()
					},
			 		function(data){

			 			if(data.status=="success") {

							$("button[type=submit]").text("Touched").addClass("disabled");
			 			} else {

			 				alert("Error touching - database says: "+data.message);
							$("button[type=submit]").text("Touch").removeClass("disabled");
			 			}

				},"json");
				return false;
			});



		});


		</script>

	</body>
</html>
